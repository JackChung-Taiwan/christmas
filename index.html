<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è–èª•å–®å­—å¿è€… - Flashcard Ninja</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #1a1a1a;
            font-family: 'Arial Black', sans-serif;
            overflow: hidden;
            user-select: none;
        }

        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: radial-gradient(circle, #2b3e50 0%, #000000 100%);
            overflow: hidden;
        }

        /* èƒŒæ™¯è£é£¾ */
        .bg-pattern {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCIgb3BhY2l0eT0iMC4xIj48dGV4dCB4PSIxMCIgeT0iMzUiIGZvbnQtc2l6ZT0iMjAiPkl8PC90ZXh0Pjwvc3ZnPg==');
            opacity: 0.1;
            pointer-events: none;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            transform: scaleX(-1); /* é¡åƒç¿»è½‰ */
        }

        .input_video { display: none; }

        /* UI å±¤ */
        #ui-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }

        #score-board {
            font-size: 40px;
            color: #fff;
            text-shadow: 0 0 10px #00ff00;
            display: flex;
            gap: 20px;
        }

        .lives { color: #ff0000; }

        #start-screen, #game-over-screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            pointer-events: auto;
        }

        h1 { color: #FFD700; font-size: 60px; margin: 0; text-shadow: 3px 3px 0 #c41e3a; }
        p { color: #fff; font-size: 24px; margin: 20px 0; }
        
        button {
            padding: 15px 40px;
            font-size: 28px;
            background: #c41e3a;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(196, 30, 58, 0.4);
            transition: transform 0.2s;
            font-family: inherit;
        }
        button:hover { transform: scale(1.1); background: #e74c3c; }

        #combo-text {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 80px;
            color: #FFD700;
            opacity: 0;
            transition: opacity 0.2s;
            text-shadow: 0 0 20px orange;
        }
    </style>
</head>
<body>

<div id="game-container">
    <div class="bg-pattern"></div>
    <video class="input_video"></video>
    <canvas class="output_canvas"></canvas>

    <div id="ui-layer">
        <div id="score-board">
            <div>SCORE: <span id="score">0</span></div>
            <div class="lives" id="lives">â¤ï¸â¤ï¸â¤ï¸</div>
        </div>
        <div id="combo-text">COMBO!</div>
    </div>

    <div id="start-screen">
        <h1>ğŸ„ è–èª•å–®å­—å¿è€…</h1>
        <p>æ®å‹•ä½ çš„æ‰‹æŒ‡åˆ‡é–‹å–®å­—å¡ï¼Œé¿é–‹ç…¤ç‚­ï¼</p>
        <p style="font-size: 16px; color: #aaa;">(è«‹å…è¨±æ”å½±æ©Ÿæ¬Šé™ï¼Œè¼‰å…¥éœ€è¦ç´„ 5-10 ç§’)</p>
        <button onclick="startGame()">START GAME</button>
    </div>

    <div id="game-over-screen" style="display: none;">
        <h1>GAME OVER</h1>
        <p>Final Score: <span id="final-score">0</span></p>
        <button onclick="resetGame()">PLAY AGAIN</button>
    </div>
</div>

<script>
    const canvas = document.querySelector('.output_canvas');
    const ctx = canvas.getContext('2d');
    const videoElement = document.querySelector('.input_video');
    const scoreEl = document.getElementById('score');
    const livesEl = document.getElementById('lives');
    const startScreen = document.getElementById('start-screen');
    const gameOverScreen = document.getElementById('game-over-screen');
    const comboEl = document.getElementById('combo-text');

    // èª¿æ•´ Canvas å°ºå¯¸
    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // --- è³‡æ–™åº« (å–®å­—å¡) ---
    const VOCAB_DB = [
        { word: 'Santa', icon: 'ğŸ…', color: '#ffcccc' },
        { word: 'Tree', icon: 'ğŸ„', color: '#ccffcc' },
        { word: 'Gift', icon: 'ğŸ', color: '#ffffcc' },
        { word: 'Star', icon: 'â­', color: '#ffffaa' },
        { word: 'Snow', icon: 'â„ï¸', color: '#eefaff' },
        { word: 'Bell', icon: 'ğŸ””', color: '#ffebcd' },
        { word: 'Sock', icon: 'ğŸ§¦', color: '#ffe6e6' },
        { word: 'Deer', icon: 'ğŸ¦Œ', color: '#ebd6ad' },
        { word: 'Elf', icon: 'ğŸ§', color: '#d0f0c0' },
        { word: 'Candy', icon: 'ğŸ¬', color: '#ffccf2' }
    ];

    // --- éŠæˆ²åƒæ•¸ ---
    let gameState = {
        isPlaying: false,
        score: 0,
        lives: 3,
        objects: [], // é£›åœ¨ç©ºä¸­çš„ç‰©é«”
        particles: [], // åˆ‡é–‹çš„ç‰¹æ•ˆ
        slices: [], // åˆ€å…‰è»Œè·¡
        hand: { x: -100, y: -100, prevX: -100, prevY: -100, speed: 0 },
        combo: 0,
        comboTimer: null
    };

    const GRAVITY = 0.25;
    const BLADE_LIFE = 10; // åˆ€å…‰æ®˜ç•™å¹€æ•¸
    const SPAWN_RATE = 50; // ç”¢ç”Ÿé »ç‡
    let frameCount = 0;

    // --- è²éŸ³åˆæˆ (TTS) ---
    function speak(text) {
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 1.2;
            window.speechSynthesis.speak(utterance);
        }
    }

    // --- é¡åˆ¥å®šç¾© ---

    // 1. éŠæˆ²ç‰©ä»¶ (å¡ç‰‡æˆ–ç‚¸å½ˆ)
    class GameObject {
        constructor() {
            this.active = true;
            this.radius = 60; // ç¢°æ’åŠå¾‘
            
            // éš¨æ©Ÿç™¼å°„ä½ç½® (åº•éƒ¨)
            this.x = Math.random() * (canvas.width - 200) + 100;
            this.y = canvas.height + 100;
            
            // ç™¼å°„é€Ÿåº¦ (å¾€ä¸Šæ‹‹ï¼Œç¨å¾®å¾€ä¸­é–“å)
            this.vx = (Math.random() - 0.5) * 6; // æ°´å¹³éš¨æ©Ÿ
            // å¦‚æœåœ¨å·¦é‚Šï¼Œå¾€å³æ‹‹ï¼›åœ¨å³é‚Šï¼Œå¾€å·¦æ‹‹
            if (this.x < canvas.width/2) this.vx = Math.abs(this.vx);
            else this.vx = -Math.abs(this.vx);

            this.vy = -(Math.random() * 8 + 14); // å‚ç›´å‘ä¸ŠåŠ›åº¦
            this.rotation = Math.random() * Math.PI * 2;
            this.rotationSpeed = (Math.random() - 0.5) * 0.1;

            // æ±ºå®šé¡å‹ (20% æ©Ÿç‡æ˜¯ç‚¸å½ˆ)
            if (Math.random() < 0.2) {
                this.type = 'bomb';
                this.icon = 'âš«'; // ç…¤ç‚­
                this.word = 'COAL';
                this.color = '#333';
            } else {
                this.type = 'card';
                const data = VOCAB_DB[Math.floor(Math.random() * VOCAB_DB.length)];
                this.icon = data.icon;
                this.word = data.word;
                this.color = data.color;
            }
        }

        update() {
            this.x += this.vx;
            this.y += this.vy;
            this.vy += GRAVITY; // é‡åŠ›
            this.rotation += this.rotationSpeed;

            // é‚Šç•Œæª¢æŸ¥ (æ‰å‡ºç•«é¢)
            if (this.y > canvas.height + 150) {
                this.active = false;
                if (this.type === 'card' && gameState.isPlaying) {
                    loseLife(); // æ¼æ¥å–®å­—å¡æ‰£è¡€
                }
            }
        }

        draw() {
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(this.rotation);

            // ç¹ªè£½å¡ç‰‡æ¨£å¼
            if (this.type === 'bomb') {
                // ç‚¸å½ˆ (ç…¤ç‚­)
                ctx.beginPath();
                ctx.arc(0, 0, 40, 0, Math.PI * 2);
                ctx.fillStyle = "#222";
                ctx.fill();
                ctx.strokeStyle = "#555";
                ctx.lineWidth = 3;
                ctx.stroke();
                ctx.font = "40px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText("ğŸ’£", 0, 0);
                
                // å°ç«ç·šé–ƒçˆ
                if (frameCount % 10 < 5) {
                    ctx.beginPath();
                    ctx.arc(25, -25, 5, 0, Math.PI * 2);
                    ctx.fillStyle = "red";
                    ctx.fill();
                }
            } else {
                // å–®å­—å¡ (æ‹ç«‹å¾—é¢¨æ ¼)
                const w = 120;
                const h = 150;
                
                // å¡ç‰‡é™°å½±
                ctx.shadowColor = "rgba(0,0,0,0.3)";
                ctx.shadowBlur = 10;
                
                // å¡ç‰‡åº•è‰²
                ctx.fillStyle = "#fff";
                ctx.fillRect(-w/2, -h/2, w, h);
                
                // åœ–ç‰‡å€åŸŸ
                ctx.fillStyle = this.color;
                ctx.fillRect(-w/2 + 10, -h/2 + 10, w - 20, w - 20);
                
                // é™°å½±é‡ç½®
                ctx.shadowBlur = 0;

                // Emoji
                ctx.font = "60px Arial";
                ctx.textAlign = "center";
                ctx.textBaseline = "middle";
                ctx.fillText(this.icon, 0, -15);

                // æ–‡å­—
                ctx.fillStyle = "#333";
                ctx.font = "bold 20px Arial";
                ctx.fillText(this.word, 0, 50);
            }

            ctx.restore();
        }
    }

    // 2. ç²’å­æ•ˆæœ (åˆ‡é–‹å¾Œçš„ç¢ç‰‡)
    class Particle {
        constructor(x, y, color, isEmoji = false, text = '') {
            this.x = x;
            this.y = y;
            this.vx = (Math.random() - 0.5) * 10;
            this.vy = (Math.random() - 0.5) * 10;
            this.life = 1.0;
            this.color = color;
            this.isEmoji = isEmoji;
            this.text = text;
        }
        update() {
            this.x += this.vx;
            this.y += this.vy;
            this.vy += GRAVITY;
            this.life -= 0.02;
        }
        draw() {
            ctx.save();
            ctx.globalAlpha = this.life;
            if (this.isEmoji) {
                ctx.font = "30px Arial";
                ctx.fillText(this.text, this.x, this.y);
            } else {
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, 4, 0, Math.PI*2);
                ctx.fill();
            }
            ctx.restore();
        }
    }

    // --- éŠæˆ²é‚è¼¯ ---

    function initGame() {
        startScreen.style.display = "none";
        gameOverScreen.style.display = "none";
        gameState.score = 0;
        gameState.lives = 3;
        gameState.objects = [];
        gameState.particles = [];
        gameState.isPlaying = true;
        updateUI();
    }

    function loseLife() {
        if (!gameState.isPlaying) return;
        gameState.lives--;
        updateUI();
        
        // ç´…è‰²é–ƒçˆ
        canvas.style.backgroundColor = "rgba(255,0,0,0.5)";
        setTimeout(() => canvas.style.backgroundColor = "", 100);

        if (gameState.lives <= 0) {
            endGame();
        }
    }

    function endGame() {
        gameState.isPlaying = false;
        document.getElementById('final-score').innerText = gameState.score;
        gameOverScreen.style.display = "flex";
    }

    function updateUI() {
        scoreEl.innerText = gameState.score;
        let livesStr = "";
        for(let i=0; i<gameState.lives; i++) livesStr += "â¤ï¸";
        livesEl.innerHTML = livesStr;
    }

    function checkCombo() {
        gameState.combo++;
        if (gameState.combo > 1) {
            comboEl.innerText = gameState.combo + " COMBO!";
            comboEl.style.opacity = 1;
            gameState.score += gameState.combo * 5; // Combo åŠ åˆ†
        }
        
        // é‡ç½® Combo Timer
        if (gameState.comboTimer) clearTimeout(gameState.comboTimer);
        gameState.comboTimer = setTimeout(() => {
            gameState.combo = 0;
            comboEl.style.opacity = 0;
        }, 800); // 0.8ç§’å…§åˆ‡ä¸‹ä¸€å€‹æ‰ç®— Combo
    }

    function createSliceEffect(obj) {
        // ç”¢ç”Ÿç¢ç‰‡
        for (let i = 0; i < 10; i++) {
            gameState.particles.push(new Particle(obj.x, obj.y, obj.color));
        }
        // ç”¢ç”Ÿæ–‡å­—ç¢ç‰‡
        gameState.particles.push(new Particle(obj.x, obj.y, null, true, obj.word));
    }

    // --- ä¸»è¿´åœˆ ---

    function gameLoop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        frameCount++;

        if (gameState.isPlaying) {
            // ç”Ÿæˆç‰©ä»¶
            if (frameCount % SPAWN_RATE === 0) {
                gameState.objects.push(new GameObject());
            }

            // æ›´æ–°ç‰©ä»¶
            for (let i = gameState.objects.length - 1; i >= 0; i--) {
                let obj = gameState.objects[i];
                obj.update();
                obj.draw();

                if (!obj.active) {
                    gameState.objects.splice(i, 1);
                    continue;
                }

                // ç¢°æ’æª¢æ¸¬ (åˆ‡æ°´æœé‚è¼¯)
                // æ¢ä»¶ï¼šæ‰‹éƒ¨é€Ÿåº¦å¤ å¿« + è·é›¢å¤ è¿‘
                let dx = gameState.hand.x - obj.x;
                let dy = gameState.hand.y - obj.y;
                let dist = Math.sqrt(dx*dx + dy*dy);
                
                if (dist < obj.radius && gameState.hand.speed > 5) {
                    // åˆ‡åˆ°äº†ï¼
                    if (obj.type === 'bomb') {
                        // åˆ‡åˆ°ç‚¸å½ˆ
                        createSliceEffect(obj);
                        gameState.objects.splice(i, 1);
                        speak("Oh no!");
                        endGame(); // ç«‹å³çµæŸ
                    } else {
                        // åˆ‡åˆ°å–®å­—å¡
                        gameState.score += 10;
                        speak(obj.word); // å”¸å‡ºå–®å­—
                        createSliceEffect(obj);
                        checkCombo();
                        gameState.objects.splice(i, 1);
                        updateUI();
                    }
                }
            }
        }

        // ç¹ªè£½ç²’å­
        for (let i = gameState.particles.length - 1; i >= 0; i--) {
            let p = gameState.particles[i];
            p.update();
            p.draw();
            if (p.life <= 0) gameState.particles.splice(i, 1);
        }

        // ç¹ªè£½åˆ€å…‰ (Blade)
        drawBlade();

        requestAnimationFrame(gameLoop);
    }

    function drawBlade() {
        if (gameState.slices.length < 2) return;

        ctx.beginPath();
        ctx.moveTo(gameState.slices[0].x, gameState.slices[0].y);
        
        for (let i = 1; i < gameState.slices.length; i++) {
            let point = gameState.slices[i];
            ctx.lineTo(point.x, point.y);
        }

        // åˆ€å…‰æ¨£å¼
        ctx.shadowBlur = 20;
        ctx.shadowColor = "#00ffff"; // è—è‰²å…‰æšˆ
        ctx.strokeStyle = "#fff";
        ctx.lineWidth = 8;
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        ctx.stroke();
        
        ctx.shadowBlur = 0; // é‡ç½®

        // ç§»é™¤èˆŠçš„è»Œè·¡
        if (gameState.slices.length > BLADE_LIFE) {
            gameState.slices.shift();
        }
    }

    // --- MediaPipe æ‰‹å‹¢åµæ¸¬ ---

    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.7,
        minTrackingConfidence: 0.7
    });

    hands.onResults((results) => {
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];
            // å–å¾—é£ŸæŒ‡æŒ‡å°– (Index 8)
            const x = landmarks[8].x * canvas.width;
            const y = landmarks[8].y * canvas.height;

            // è¨ˆç®—é€Ÿåº¦
            const dx = x - gameState.hand.prevX;
            const dy = y - gameState.hand.prevY;
            gameState.hand.speed = Math.sqrt(dx*dx + dy*dy);

            // æ›´æ–°ä½ç½®
            gameState.hand.prevX = gameState.hand.x;
            gameState.hand.prevY = gameState.hand.y;
            gameState.hand.x = x;
            gameState.hand.y = y;

            // åŠ å…¥è»Œè·¡é»
            gameState.slices.push({x: x, y: y});

        } else {
            gameState.hand.speed = 0;
            // å¦‚æœæ‰‹æ¶ˆå¤±ï¼Œæ¸…ç©ºè»Œè·¡
            if(gameState.slices.length > 0) gameState.slices.shift(); 
        }
    });

    const camera = new Camera(videoElement, {
        onFrame: async () => { await hands.send({image: videoElement}); },
        width: 1280,
        height: 720
    });
    
    // å•Ÿå‹•
    camera.start();
    gameLoop();

    // UI æŒ‰éˆ•åŠŸèƒ½
    window.startGame = initGame;
    window.resetGame = initGame;

</script>
</body>
</html>
