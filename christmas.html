<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è–èª•é«”æ„Ÿæ¥ç¦®ç‰©</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #0f3854;
            background: radial-gradient(ellipse at center,  #0a2e38  0%, #000000 70%);
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: white;
        }

        #game-container {
            position: relative;
            width: 1280px;
            height: 720px;
            box-shadow: 0 0 20px rgba(0,255,0,0.2);
            background: rgba(0, 0, 0, 0.5);
            border-radius: 15px;
            overflow: hidden;
        }

        /* éš±è—åŸå§‹è¦–è¨Šï¼Œæˆ‘å€‘åªç•«åœ¨ Canvas ä¸Š */
        .input_video {
            display: none;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            transform: scaleX(-1); /* é¡åƒç¿»è½‰ï¼Œè®“æ“ä½œæ›´ç›´è¦º */
        }

        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }

        #score-board {
            font-size: 32px;
            font-weight: bold;
            text-shadow: 2px 2px 4px #000;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(180, 0, 0, 0.9);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            display: none;
            pointer-events: auto;
            cursor: pointer;
            z-index: 10;
        }
    </style>
</head>
<body>

<div id="game-container">
    <video class="input_video"></video>
    <canvas class="output_canvas" width="1280" height="720"></canvas>
    
    <div id="ui-layer">
        <div id="score-board">ğŸ„ åˆ†æ•¸: <span id="score">0</span> | ç”Ÿå‘½: <span id="lives">â¤ï¸â¤ï¸â¤ï¸</span></div>
    </div>

    <div id="loading">
        ğŸ… æ­£åœ¨å•Ÿå‹•æ”å½±æ©Ÿèˆ‡ AI æ¨¡å‹...<br>è«‹å…è¨±æ”å½±æ©Ÿæ¬Šé™<br>(é¦–æ¬¡è¼‰å…¥å¯èƒ½éœ€è¦å¹¾ç§’é˜)
    </div>

    <div id="game-over" class="game-over" onclick="restartGame()">
        <h1>ğŸ… éŠæˆ²çµæŸ! ğŸ…</h1>
        <h2 id="final-score">å¾—åˆ†: 0</h2>
        <p>é»æ“Šé€™è£¡é‡æ–°é–‹å§‹</p>
    </div>
</div>

<script>
    const videoElement = document.getElementsByClassName('input_video')[0];
    const canvasElement = document.getElementsByClassName('output_canvas')[0];
    const canvasCtx = canvasElement.getContext('2d');
    const scoreEl = document.getElementById('score');
    const livesEl = document.getElementById('lives');
    const loadingEl = document.getElementById('loading');
    const gameOverEl = document.getElementById('game-over');
    const finalScoreEl = document.getElementById('final-score');

    // éŠæˆ²ç‹€æ…‹
    let gameState = {
        score: 0,
        lives: 3,
        isPlaying: false,
        handX: 0.5, // 0 åˆ° 1 ä¹‹é–“
        handY: 0.8,
        items: [],
        particles: []
    };

    // éŠæˆ²åƒæ•¸
    const SPAWN_RATE = 60; // è¶Šå°è¶Šå¿«
    let frameCount = 0;
    const GRAVITY = 3; // æ‰è½é€Ÿåº¦åŸºç¤å€¼

    // ç‰©å“å®šç¾©
    const ITEM_TYPES = [
        { type: 'gift', emoji: 'ğŸ', score: 10, speed: 1.0, size: 50 },
        { type: 'star', emoji: 'â­', score: 30, speed: 1.5, size: 40 },
        { type: 'bomb', emoji: 'ğŸ’£', score: -10, speed: 1.2, damage: 1, size: 50 },
        { type: 'snow', emoji: 'â„ï¸', score: 1, speed: 0.8, size: 30 }
    ];

    class Item {
        constructor() {
            // éš¨æ©Ÿé¸æ“‡ç‰©å“ï¼Œç‚¸å½ˆæ©Ÿç‡è¼ƒä½
            let r = Math.random();
            let typeIdx = 0;
            if (r < 0.6) typeIdx = 0; // 60% ç¦®ç‰©
            else if (r < 0.8) typeIdx = 3; // 20% é›ªèŠ±
            else if (r < 0.95) typeIdx = 2; // 15% ç‚¸å½ˆ
            else typeIdx = 1; // 5% æ˜Ÿæ˜Ÿ

            this.data = ITEM_TYPES[typeIdx];
            this.x = Math.random() * canvasElement.width;
            this.y = -50;
            this.speed = this.data.speed * (GRAVITY + Math.random());
            this.rotation = Math.random() * Math.PI;
        }

        update() {
            this.y += this.speed;
            this.rotation += 0.05;
        }

        draw(ctx) {
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(this.rotation);
            ctx.font = `${this.data.size}px Arial`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(this.data.emoji, 0, 0);
            ctx.restore();
        }
    }

    class Particle {
        constructor(x, y, text) {
            this.x = x;
            this.y = y;
            this.vx = (Math.random() - 0.5) * 10;
            this.vy = (Math.random() - 0.5) * 10;
            this.life = 1.0;
            this.text = text;
        }
        update() {
            this.x += this.vx;
            this.y += this.vy;
            this.life -= 0.02;
        }
        draw(ctx) {
            ctx.save();
            ctx.globalAlpha = this.life;
            ctx.font = "20px Arial";
            ctx.fillStyle = "yellow";
            ctx.fillText(this.text, this.x, this.y);
            ctx.restore();
        }
    }

    // MediaPipe åˆå§‹åŒ–
    const hands = new Hands({locateFile: (file) => {
        return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
    }});

    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.7,
        minTrackingConfidence: 0.7
    });

    hands.onResults(onResults);

    const camera = new Camera(videoElement, {
        onFrame: async () => {
            await hands.send({image: videoElement});
        },
        width: 1280,
        height: 720
    });

    // ç•¶åµæ¸¬åˆ°æ‰‹éƒ¨æ™‚
    function onResults(results) {
        // æ¸…é™¤ç•«å¸ƒ
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

        // å¦‚æœé‚„åœ¨è¼‰å…¥ä¸­ï¼Œéš±è—è¼‰å…¥æç¤ºä¸¦é–‹å§‹éŠæˆ²
        if (loadingEl.style.display !== 'none') {
            loadingEl.style.display = 'none';
            if (!gameState.isPlaying && gameState.lives > 0) gameState.isPlaying = true;
        }

        // ç¹ªè£½ Webcam èƒŒæ™¯ (å¯é¸ï¼Œé€™è£¡ç‚ºäº†æ²‰æµ¸æ„Ÿæˆ‘é¸æ“‡åªç•«æ‰‹å’ŒéŠæˆ²ç‰©ä»¶ï¼Œä¿æŒé»‘è‰²èƒŒæ™¯)
        // canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);

        // è™•ç†æ‰‹éƒ¨ä½ç½®
        if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const landmarks = results.multiHandLandmarks[0];
            // å–å¾—é£ŸæŒ‡æŒ‡å°– (Index Finger Tip, ID: 8)
            // MediaPipe åº§æ¨™æ˜¯ 0-1ï¼Œéœ€è¦è½‰æ›ç‚º Canvas å°ºå¯¸
            gameState.handX = landmarks[8].x * canvasElement.width;
            gameState.handY = landmarks[8].y * canvasElement.height;
            
            drawPlayer(gameState.handX, gameState.handY);
        } else {
            // å¦‚æœæ²’åµæ¸¬åˆ°æ‰‹ï¼Œé¡¯ç¤ºæç¤º
            canvasCtx.fillStyle = "rgba(255, 255, 255, 0.5)";
            canvasCtx.font = "20px Arial";
            canvasCtx.textAlign = "center";
            canvasCtx.fillText("è«‹æ®æ®æ‰‹...", canvasElement.width / 2, canvasElement.height / 2);
        }

        if (gameState.isPlaying) {
            updateGame();
        }
    }

    function drawPlayer(x, y) {
        canvasCtx.font = "80px Arial";
        canvasCtx.textAlign = "center";
        canvasCtx.textBaseline = "middle";
        // ç¹ªè£½è–èª•è€äººè·Ÿéš¨æ‰‹éƒ¨
        canvasCtx.fillText("ğŸ…", x, y);
        
        // ç¹ªè£½é™¤éŒ¯é»(æ‰‹æŒ‡ä½ç½®)
        // canvasCtx.beginPath();
        // canvasCtx.arc(x, y, 10, 0, 2 * Math.PI);
        // canvasCtx.fillStyle = "red";
        // canvasCtx.fill();
    }

    function updateGame() {
        frameCount++;

        // ç”Ÿæˆç‰©å“
        if (frameCount % SPAWN_RATE === 0) {
            gameState.items.push(new Item());
        }
        
        // éš¨è‘—åˆ†æ•¸å¢åŠ é›£åº¦
        if(frameCount % 500 === 0 && SPAWN_RATE > 20) {
            // SPAWN_RATE -= 5; // å¯é¸ï¼šå¢åŠ é›£åº¦
        }

        // æ›´æ–°èˆ‡ç¹ªè£½ç‰©å“
        for (let i = gameState.items.length - 1; i >= 0; i--) {
            let item = gameState.items[i];
            item.update();
            item.draw(canvasCtx);

            // ç¢°æ’æª¢æ¸¬ (ç°¡å–®è·é›¢å…¬å¼)
            let dist = Math.hypot(item.x - gameState.handX, item.y - gameState.handY);
            
            // åˆ¤å®šè·é›¢ (æ‰‹çš„å¤§å°ç´„ç‚º 60px åŠå¾‘)
            if (dist < 60) {
                handleCollision(item, i);
            } else if (item.y > canvasElement.height) {
                // è¶…å‡ºç•«é¢ç§»é™¤
                gameState.items.splice(i, 1);
            }
        }

        // æ›´æ–°ç‰¹æ•ˆ
        for (let i = gameState.particles.length - 1; i >= 0; i--) {
            let p = gameState.particles[i];
            p.update();
            p.draw(canvasCtx);
            if (p.life <= 0) gameState.particles.splice(i, 1);
        }
    }

    function handleCollision(item, index) {
        gameState.items.splice(index, 1); // ç§»é™¤ç‰©å“

        if (item.data.type === 'bomb') {
            gameState.lives -= item.data.damage;
            gameState.particles.push(new Particle(gameState.handX, gameState.handY, "BOOM!"));
            updateUI();
            if (gameState.lives <= 0) endGame();
        } else {
            gameState.score += item.data.score;
            gameState.particles.push(new Particle(gameState.handX, gameState.handY, "+" + item.data.score));
            updateUI();
        }
    }

    function updateUI() {
        scoreEl.innerText = gameState.score;
        let livesStr = "";
        for(let i=0; i<gameState.lives; i++) livesStr += "â¤ï¸";
        livesEl.innerText = livesStr;
    }

    function endGame() {
        gameState.isPlaying = false;
        finalScoreEl.innerText = "å¾—åˆ†: " + gameState.score;
        gameOverEl.style.display = "block";
    }

    window.restartGame = function() {
        gameState.score = 0;
        gameState.lives = 3;
        gameState.items = [];
        gameState.particles = [];
        updateUI();
        gameOverEl.style.display = "none";
        gameState.isPlaying = true;
    }

    // å•Ÿå‹•æ”å½±æ©Ÿ
    camera.start();

</script>

</body>
</html>